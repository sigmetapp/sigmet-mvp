# Исправления для Real-time доставки сообщений

## Проблема
Сообщения в диалогах приходят с задержками, а не в реальном времени, и появляются только после обновления страницы.

## Причины и исправления

### 1. Ограничение eventsPerSecond
**Проблема:** В `lib/dm/realtimeServer.ts` было установлено ограничение `eventsPerSecond: 5`, что могло замедлять доставку сообщений.

**Исправление:** Увеличено до `eventsPerSecond: 50` для более быстрой доставки сообщений.

### 2. Отсутствие репликации для real-time подписок
**Проблема:** Таблица `dms_messages` не была добавлена в публикацию `supabase_realtime`, что могло препятствовать real-time подпискам.

**Исправление:** Создана миграция `158_enable_realtime_replication.sql`, которая:
- Добавляет таблицы `dms_messages`, `dms_threads`, `dms_message_receipts` в публикацию `supabase_realtime`
- Устанавливает `replica identity full` для лучшего отслеживания изменений

### 3. Улучшена обработка подписок
**Проблема:** Подписки в `useDmRealtime` не имели явной конфигурации и логирования статуса.

**Исправление:** 
- Добавлена конфигурация `broadcast: { self: true }` для канала
- Добавлено логирование статуса подписки для отладки

## Тестирование

Создан тест `tests/realtime-delay.spec.ts` для проверки:
- Доставки сообщений в реальном времени без задержек
- Появления сообщений без обновления страницы
- Обработки высокой частоты сообщений

## Следующие шаги

1. **Применить миграцию:**
   ```bash
   # Применить миграцию в Supabase
   supabase migration up
   ```

2. **Проверить настройки Supabase:**
   - Убедиться, что real-time включен в настройках проекта
   - Проверить, что нет дополнительных ограничений на скорость

3. **Мониторинг:**
   - Проверить логи в консоли браузера на наличие ошибок подписки
   - Проверить статус подписок через `console.log` в `useDmRealtime`

4. **Дополнительные проверки:**
   - Убедиться, что WebSocket соединение работает (если используется)
   - Проверить, что нет проблем с сетью или прокси

## Возможные дополнительные проблемы

Если проблема сохраняется, проверьте:

1. **Настройки Supabase Dashboard:**
   - Realtime должен быть включен
   - Проверьте лимиты на количество подписок

2. **Сетевая задержка:**
   - Проверьте ping до Supabase серверов
   - Убедитесь, что нет проблем с CORS или прокси

3. **Клиентские подписки:**
   - Убедитесь, что подписки не отменяются преждевременно
   - Проверьте, что нет конфликтов между несколькими подписками

4. **База данных:**
   - Проверьте, что триггеры работают правильно
   - Убедитесь, что нет блокировок на таблице `dms_messages`
