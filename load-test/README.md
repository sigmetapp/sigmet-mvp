# Load Testing Suite

Набор инструментов для имитации нагрузки 200 одновременных пользователей и мониторинга ресурсов системы.

## Структура

- `k6-load-test.js` - Скрипт для k6 (рекомендуется, самый мощный)
- `node-load-test.js` - Node.js альтернатива (не требует установки k6)
- `monitor-resources.js` - Мониторинг ресурсов (CPU, память, сеть)

## Быстрый старт

### Вариант 1: Node.js (проще, без дополнительных зависимостей)

1. **Запустите мониторинг ресурсов в отдельном терминале:**
```bash
cd load-test
node monitor-resources.js
```

2. **В другом терминале запустите нагрузочный тест:**
```bash
# Базовый тест (200 пользователей, 5 минут)
node node-load-test.js

# С настройками
BASE_URL=http://localhost:3000 \
CONCURRENT_USERS=200 \
DURATION_SECONDS=300 \
node node-load-test.js
```

### Вариант 2: k6 (более мощный, нужна установка)

1. **Установите k6:**
```bash
# macOS
brew install k6

# Linux
sudo apt-get install k6
# или
sudo yum install k6

# Windows
winget install k6
```

2. **Запустите тест:**
```bash
cd load-test
k6 run k6-load-test.js

# С настройками
BASE_URL=http://localhost:3000 k6 run k6-load-test.js
```

## Конфигурация

### Переменные окружения для Node.js скрипта:

- `BASE_URL` - URL приложения (по умолчанию: `http://localhost:3000`)
- `CONCURRENT_USERS` - Количество одновременных пользователей (по умолчанию: `200`)
- `DURATION_SECONDS` - Длительность теста в секундах (по умолчанию: `300` = 5 минут)
- `RAMP_UP_SECONDS` - Время наращивания нагрузки (по умолчанию: `60` секунд)
- `TEST_USERS` - JSON массив пользователей с токенами для тестирования авторизованных эндпоинтов

Пример:
```bash
TEST_USERS='[{"token":"xxx"},{"token":"yyy"}]' node node-load-test.js
```

### Переменные окружения для k6:

- `BASE_URL` - URL приложения
- `TEST_USERS` - JSON массив пользователей с токенами

### Переменные окружения для мониторинга:

- `MONITOR_INTERVAL_MS` - Интервал сбора метрик в миллисекундах (по умолчанию: `5000`)
- `MONITOR_DURATION_SECONDS` - Длительность мониторинга (по умолчанию: `600` = 10 минут)
- `MONITOR_OUTPUT` - Файл для сохранения результатов (по умолчанию: `load-test-resources.json`)

## Что тестируется

### Публичные эндпоинты:
- `/` - Главная страница
- `/api/ping` - Health check
- `/api/search` - Поиск

### Авторизованные эндпоинты (если предоставлены токены):
- `/feed` - Лента
- `/profile` - Профиль
- `/api/dms/threads.list` - Список чатов
- `/api/growth/directions.list` - Направления роста

## Результаты

### Node.js скрипт выводит:
- Общее количество запросов
- Успешные/неуспешные запросы
- Время ответа (среднее, P50, P95, P99)
- Статус коды
- Предупреждения о проблемах производительности

### k6 скрипт создает:
- `load-test-results.json` - Детальные результаты в JSON
- Консольный вывод с метриками

### Мониторинг ресурсов создает:
- `load-test-resources.json` - История метрик (CPU, память, сеть)
- Консольный вывод в реальном времени
- Итоговую статистику

## Анализ результатов

### Что проверять:

1. **Время ответа:**
   - P95 < 2 секунды - хорошо
   - P95 > 2 секунды - возможны проблемы
   - P95 > 5 секунд - серьезные проблемы

2. **Процент ошибок:**
   - < 1% - отлично
   - 1-5% - приемлемо, но нужно проверить
   - > 5% - проблемы со стабильностью

3. **CPU:**
   - Среднее < 70% - хорошо
   - Среднее > 80% - система перегружена
   - Пики > 95% - критическая перегрузка

4. **Память:**
   - Среднее < 75% - хорошо
   - Среднее > 85% - риск OOM
   - Пики > 90% - критично

5. **Requests per second:**
   - Сравните с ожидаемой нагрузкой
   - Проверьте, не падает ли RPS при увеличении нагрузки

## Типичные проблемы и решения

### Высокое время ответа:
- Проверьте базу данных (индексы, медленные запросы)
- Проверьте количество соединений к БД
- Увеличьте ресурсы сервера/контейнера
- Оптимизируйте запросы (N+1 проблемы, избыточные данные)

### Высокий процент ошибок:
- Проверьте лимиты соединений (DB, HTTP)
- Проверьте логи ошибок
- Увеличьте timeout значения
- Проверьте квоты API (Supabase, Vercel)

### Высокая нагрузка на CPU:
- Оптимизируйте код (уберите лишние вычисления)
- Используйте кеширование
- Увеличьте количество инстансов/процессов
- Проверьте на утечки памяти

### Высокая нагрузка на память:
- Проверьте на утечки памяти
- Уменьшите размер payload
- Оптимизируйте запросы к БД (меньше данных)
- Увеличьте доступную память

## Расширенное использование

### Тестирование с реальными пользователями:

1. Создайте тестовых пользователей в Supabase
2. Получите их токены
3. Передайте в `TEST_USERS`:

```bash
TEST_USERS='[
  {"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."},
  {"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."}
]' node node-load-test.js
```

### Тестирование конкретных эндпоинтов:

Отредактируйте скрипты, добавив нужные эндпоинты в массив сценариев.

### Длительный тест:

```bash
# 30 минут нагрузки
DURATION_SECONDS=1800 node node-load-test.js
```

## Запуск в CI/CD

Добавьте в `package.json`:

```json
{
  "scripts": {
    "load-test": "cd load-test && node node-load-test.js",
    "load-test:k6": "cd load-test && k6 run k6-load-test.js"
  }
}
```

Затем:
```bash
npm run load-test
```

## Примечания

- Тестируйте на staging окружении, не на production
- Убедитесь, что у вас достаточно ресурсов для тестирования
- Мониторинг ресурсов работает лучше на Linux
- Для более точных результатов используйте k6
- Для быстрого тестирования используйте Node.js скрипт