# –ù–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚úÖ
- ‚úÖ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î (–∏–Ω–¥–µ–∫—Å—ã, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
- ‚úÖ –£–ª—É—á—à–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ sequence_number
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (DmErrorHandler)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –£–ª—É—á—à–µ–Ω–∏—è UX ‚úÖ
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (IndexedDB)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å ‚úÖ
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å WebSocket gateway
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

---

## ‚ùå –ù–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ ‚ùå

#### 4.1 –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è (—É–±—Ä–∞—Ç—å `any`)
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞–π–¥–µ–Ω–æ 60+ –≤—Ö–æ–∂–¥–µ–Ω–∏–π `any` –≤ `lib/dm/*`
**–§–∞–π–ª—ã —Å `any`:**
- `lib/dm/gateway.ts` - 12 –≤—Ö–æ–∂–¥–µ–Ω–∏–π
- `lib/dm/broker.ts` - 7 –≤—Ö–æ–∂–¥–µ–Ω–∏–π
- `lib/dm/cache.ts` - 6 –≤—Ö–æ–∂–¥–µ–Ω–∏–π
- `lib/dm/errorHandler.ts` - 2 –≤—Ö–æ–∂–¥–µ–Ω–∏—è
- `lib/dm/websocket.ts` - 4 –≤—Ö–æ–∂–¥–µ–Ω–∏—è
- `lib/dm/attachments.ts` - 7 –≤—Ö–æ–∂–¥–µ–Ω–∏–π
- –ò –¥—Ä—É–≥–∏–µ...

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –í–º–µ—Å—Ç–æ:
function handleMessage(data: any) { ... }

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
function handleMessage(data: GatewayMessage) { ... }
```

#### 4.2 –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (Zod)
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ —Å–µ—Ä–≤–µ—Ä–µ
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `zod`
- –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π/–æ–±—Ä–∞–±–æ—Ç–∫–æ–π

**–ü—Ä–∏–º–µ—Ä:**
```typescript
import { z } from 'zod';

const MessageSchema = z.object({
  id: z.number().int().positive(),
  thread_id: z.string(),
  sender_id: z.string().uuid(),
  kind: z.enum(['text', 'system']),
  body: z.string().nullable(),
  // ...
});

function validateMessage(data: unknown): Message {
  return MessageSchema.parse(data);
}
```

#### 4.3 –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (DOMPurify)
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–ü—Ä–æ–±–ª–µ–º–∞:** –í–æ–∑–º–æ–∂–Ω—ã XSS –∞—Ç–∞–∫–∏ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `dompurify`
- –°–∞–Ω–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å HTML/—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
- –û—á–∏—Å—Ç–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç

**–ü—Ä–∏–º–µ—Ä:**
```typescript
import DOMPurify from 'dompurify';

function sanitizeMessage(text: string): string {
  return DOMPurify.sanitize(text, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'code', 'pre'],
    ALLOWED_ATTR: ['href', 'target', 'rel']
  });
}
```

---

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–∏–∑ LOADING_ANALYSIS)

#### Next.js loading.tsx
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å `loading.tsx` —Ñ–∞–π–ª—ã –¥–ª—è route-level loading states
- `app/(auth)/dms/loading.tsx`
- `app/(auth)/feed/loading.tsx`
- –ò –¥—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ routes

#### Progressive Image Loading
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- Blur placeholder –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- Lazy loading —Å placeholder

#### Suspense Boundaries
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å React Suspense –¥–ª—è progressive loading –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

---

## üìä –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å):
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (Zod)** - –∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. **–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (DOMPurify)** - –∑–∞—â–∏—Ç–∞ –æ—Ç XSS
3. **–°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è** - —É–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—à–∏–±–æ–∫

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (UX):
4. **Next.js loading.tsx** - —É–ª—É—á—à–µ–Ω–∏–µ UX –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
5. **Progressive Image Loading** - —É–ª—É—á—à–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
6. **Suspense Boundaries** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

---

## üì¶ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ 4 –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:

```bash
npm install zod dompurify
npm install --save-dev @types/dompurify
```

---

## üéØ –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ 0% XSS —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- ‚úÖ 100% –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ < 5% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `any` —Ç–∏–ø–æ–≤

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ —Å–µ—Ä–≤–µ—Ä–µ
- ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
