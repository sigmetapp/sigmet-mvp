# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –í—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ

## –†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å–∏—Å—Ç–µ–º—ã DMs —Å–æ–≥–ª–∞—Å–Ω–æ –ø–ª–∞–Ω—É —É–ª—É—á—à–µ–Ω–∏–π.

---

## ‚úÖ 1. –£–ø—Ä–æ—â–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `client_msg_id`
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- –í–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

### –†–µ—à–µ–Ω–∏–µ
–°–æ–∑–¥–∞–Ω–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `addOrUpdateMessage()` –≤ `hooks/useWebSocketDm.ts`:

```typescript
function addOrUpdateMessage(messages: Message[], newMessage: Message): Message[] {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ id (–≥–ª–∞–≤–Ω—ã–π –∫–ª—é—á)
  const existingIndex = messages.findIndex(m => m.id === newMessage.id);
  if (existingIndex !== -1) {
    // –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const updated = [...messages];
    updated[existingIndex] = newMessage;
    return sortMessagesChronologically(updated);
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ local-echo –ø–æ sequence_number
  if (newMessage.id !== -1 && newMessage.sequence_number !== null) {
    const localEchoIndex = messages.findIndex(m => 
      m.id === -1 && 
      m.sequence_number === newMessage.sequence_number &&
      m.thread_id === newMessage.thread_id
    );
    if (localEchoIndex !== -1) {
      // –ó–∞–º–µ–Ω–∏—Ç—å local-echo —Ä–µ–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
      const updated = [...messages];
      updated[localEchoIndex] = newMessage;
      return sortMessagesChronologically(updated);
    }
  }
  
  // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  return sortMessagesChronologically([...messages, newMessage]);
}
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –£–±—Ä–∞–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å `client_msg_id` —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `id` –∏ `sequence_number` –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ local-echo —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ `handleMessage` –∏ `handleSync`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ fallback –ª–æ–≥–∏–∫–∞ –¥–ª—è Supabase Realtime

### –§–∞–π–ª—ã
- `hooks/useWebSocketDm.ts` - —É–ø—Ä–æ—â–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è

---

## ‚úÖ 2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

### –ü—Ä–æ–±–ª–µ–º–∞
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `dms_list_partners`

### –†–µ—à–µ–Ω–∏–µ

#### 2.1 –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã
–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `166_optimize_dm_queries.sql`:

```sql
-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX IF NOT EXISTS idx_dms_messages_thread_sequence 
ON dms_messages(thread_id, sequence_number);

CREATE INDEX IF NOT EXISTS idx_dms_thread_participants_user_thread 
ON dms_thread_participants(user_id, thread_id);

CREATE INDEX IF NOT EXISTS idx_dms_message_receipts_message_user 
ON dms_message_receipts(message_id, user_id);

CREATE INDEX IF NOT EXISTS idx_dms_threads_last_message_at 
ON dms_threads(last_message_at DESC NULLS LAST);
```

#### 2.2 –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `dms_list_partners`
–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `dms_list_partners_optimized`:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç CTEs –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- –£–ª—É—á—à–µ–Ω –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### 2.3 –û–±–Ω–æ–≤–ª–µ–Ω API endpoint
`pages/api/dms/partners.list.ts`:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å fallback –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

### –§–∞–π–ª—ã
- `supabase/migrations/166_optimize_dm_queries.sql` - –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
- `pages/api/dms/partners.list.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

---

## ‚úÖ 3. –£–ª—É—á—à–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ sequence_number

### –ü—Ä–æ–±–ª–µ–º–∞
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `id` –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø–æ—Ä—è–¥–∫–∞ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ merge —Å–æ–æ–±—â–µ–Ω–∏–π

### –†–µ—à–µ–Ω–∏–µ

#### 3.1 –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ gateway.ts
`lib/dm/gateway.ts` - —Ñ—É–Ω–∫—Ü–∏—è `handleSync`:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `sequence_number` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ, —á–µ–º `id`)
- –ü–æ–ª—É—á–∞–µ—Ç `sequence_number` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `sequence_number` –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- Fallback –Ω–∞ `id` –µ—Å–ª–∏ `sequence_number` –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

```typescript
// Get last sequence_number from last_server_msg_id if provided
let lastSequenceNumber: number | null = null;
if (lastServerMsgId !== null) {
  const { data: lastMessage } = await supabase
    .from('dms_messages')
    .select('sequence_number')
    .eq('thread_id', threadId)
    .eq('id', lastServerMsgId)
    .maybeSingle();
  
  if (lastMessage?.sequence_number) {
    lastSequenceNumber = typeof lastMessage.sequence_number === 'string'
      ? parseInt(lastMessage.sequence_number, 10)
      : Number(lastMessage.sequence_number);
  }
}

// Fetch messages after last sequence_number (more reliable than id)
let query = supabase
  .from('dms_messages')
  .select('*')
  .eq('thread_id', threadId)
  .order('sequence_number', { ascending: true })
  .order('id', { ascending: true }); // Fallback ordering by id

if (lastSequenceNumber !== null) {
  query = query.gt('sequence_number', lastSequenceNumber);
}
```

#### 3.2 –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ merge –≤ useWebSocketDm
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `addOrUpdateMessage` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —á–µ—Ä–µ–∑ `sequence_number`

### –§–∞–π–ª—ã
- `lib/dm/gateway.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- `hooks/useWebSocketDm.ts` - —É–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ merge

---

## ‚úÖ 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞
- –ú–Ω–æ–≥–æ try-catch —Å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫
- –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏

### –†–µ—à–µ–Ω–∏–µ

#### 4.1 –°–æ–∑–¥–∞–Ω DmErrorHandler
–ù–æ–≤—ã–π —Ñ–∞–π–ª `lib/dm/errorHandler.ts`:
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ DMs
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –ø–æ severity (low, medium, high, critical)
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ retryable –æ—à–∏–±–æ–∫
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Sentry (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

#### 4.2 –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
```typescript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
handleDmError(error, {
  component: 'useWebSocketDm',
  action: 'websocket_error',
  threadId: normalizedThreadId,
  code: event.code,
});

// –°–æ–∑–¥–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
const error = createDmError(
  'Connection failed',
  'CONNECTION_ERROR',
  { component: 'gateway' },
  'high'
);

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
const userMessage = getUserFriendlyMessage(error);
// "–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É."
```

#### 4.3 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ `hooks/useWebSocketDm.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket –æ—à–∏–±–æ–∫
- ‚úÖ `lib/dm/gateway.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### –§–∞–π–ª—ã
- `lib/dm/errorHandler.ts` - –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- `hooks/useWebSocketDm.ts` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- `lib/dm/gateway.ts` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è - –º–µ–Ω—å—à–µ –ø—Ä–æ–≤–µ—Ä–æ–∫, –±—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã - —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `dms_list_partners` - –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–≤–µ—Ç

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `sequence_number` - –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–æ—Ä—è–¥–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è - –º–µ–Ω—å—à–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - –ª—É—á—à–µ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ - –ª–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ
- ‚úÖ –õ—É—á—à–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ - –ø—Ä–æ—â–µ –æ—Ç–ª–∞–¥–∫–∞

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase
supabase migration up
# –∏–ª–∏ —á–µ—Ä–µ–∑ Supabase Dashboard
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ Sentry (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–±–ª–µ–º

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- Fallback –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤ production

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [x] –£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
- [x] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î (–∏–Ω–¥–µ–∫—Å—ã)
- [x] –°–æ–∑–¥–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `dms_list_partners_optimized`
- [x] –û–±–Ω–æ–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ `sequence_number`
- [x] –°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- [x] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –ë–î
- [x] –û–±–Ω–æ–≤–∏—Ç—å API endpoints

**–í—Å–µ –∑–∞–¥–∞—á–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ 1 –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! ‚úÖ**
