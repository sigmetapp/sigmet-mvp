# –ê–Ω–∞–ª–∏–∑ –∏ —É–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã Direct Messaging (DMs)

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–≥–∏–±—Ä–∏–¥–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** —Å –¥–≤—É–º—è –∫–∞–Ω–∞–ª–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏:
1. **WebSocket Gateway** (`lib/dm/gateway.ts`) - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –¥–ª—è real-time
2. **Supabase Realtime** (`lib/dm/realtime.ts`) - fallback –∫–∞–Ω–∞–ª

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **Frontend**: React hooks (`useWebSocketDm`, `useDmRealtime`)
- **Backend**: API endpoints (`/api/dms/*`)
- **Real-time**: WebSocket server + Supabase Realtime
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL (Supabase) —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏:
  - `dms_threads` - –¥–∏–∞–ª–æ–≥–∏
  - `dms_messages` - —Å–æ–æ–±—â–µ–Ω–∏—è
  - `dms_thread_participants` - —É—á–∞—Å—Ç–Ω–∏–∫–∏
  - `dms_message_receipts` - —Å—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏
  - `dms_blocks` - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `client_msg_id`
- Local-echo —Å–æ–æ–±—â–µ–Ω–∏—è —Å `id: -1` –∑–∞–º–µ–Ω—è—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–º–∏
- –í–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ WebSocket
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `sentClientMsgIdsRef` –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä—ã:**
```typescript
// useWebSocketDm.ts:283-321
if (clientMsgId && sentClientMsgIdsRef.current.has(clientMsgId)) {
  // –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–º–µ–Ω—ã local-echo
  // –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—É–±–ª–∏–∫–∞—Ç–∞–º
}
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (sequence_number)
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é: –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ `id` –∏ `sequence_number`
- –£–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ `client_msg_id` –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

### 2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- –ù–µ—Ç –±–∞—Ç—á–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ sessionStorage (–Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è)

**–ü—Ä–∏–º–µ—Ä—ã:**
```typescript
// partners.list.ts - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
const [{ data: iFollowRows }, { data: followMeRows }] = await Promise.all([...]);
// –ó–∞—Ç–µ–º –µ—â–µ –∑–∞–ø—Ä–æ—Å –∫ profiles
const { data: mutualProfiles } = await client.from('profiles')...
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PostgreSQL —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ JOIN –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö SELECT

### 3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `last_server_msg_id` –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø–æ—Ä—è–¥–∫–∞ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ merge —Å–æ–æ–±—â–µ–Ω–∏–π

**–ü—Ä–∏–º–µ—Ä—ã:**
```typescript
// useWebSocketDm.ts:445-484
const handleSync = (event: WSEvent) => {
  // Merge –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
  setMessagesState((prev) => {
    const byId = new Map<number, Message>();
    // ...
  });
};
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sequence_number` –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø–æ—Ä—è–¥–∫–∞
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å range-based —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é (–æ—Ç sequence_number –¥–æ —Ç–µ–∫—É—â–µ–≥–æ)
- –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç-—Ä–µ–∑–æ–ª—é—à–Ω

### 4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å WebSocket**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- WebSocket gateway –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –±–µ–∑ Redis
- –ù–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –±—Ä–æ–∫–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ö–∞–∂–¥—ã–π –∏–Ω—Å—Ç–∞–Ω—Å —Ö—Ä–∞–Ω–∏—Ç —Å–≤–æ–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis Pub/Sub –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ (Pusher, Ably, Socket.io —Å Redis adapter)

### 5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–Ω–æ–≥–æ try-catch —Å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫
- –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ü—Ä–∏–º–µ—Ä—ã:**
```typescript
// gateway.ts:313
void broadcastDmMessage(threadId, normalized).catch((err) => {
  gatewayLogger.warn('Broadcast message mirror failed:', err);
  // –û—à–∏–±–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
});
```

**–†–µ—à–µ–Ω–∏–µ:**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (Sentry, LogRocket)
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
- Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 6. **UX: –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Local-echo —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É, –Ω–æ —Å—Ç–∞—Ç—É—Å –Ω–µ –≤—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –ù–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è", "–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", "–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ", "–ø—Ä–æ—á–∏—Ç–∞–Ω–æ"
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞ (—á–µ–∫–º–∞—Ä–∫–∏)
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏/–¥–æ—Å—Ç–∞–≤–∫–∏
- –£–≤–µ–¥–æ–º–ª—è—Ç—å –æ–± –æ—à–∏–±–∫–∞—Ö –æ—Ç–ø—Ä–∞–≤–∫–∏

### 7. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ sessionStorage (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ 5-10MB)
- –ù–µ—Ç –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö
- –ö—ç—à –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IndexedDB –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞
- –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞

### 8. **–¢–∏–ø–∏–∑–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–Ω–æ–≥–æ `any` —Ç–∏–ø–æ–≤
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- –í–æ–∑–º–æ–∂–Ω—ã XSS —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
- –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è (—É–±—Ä–∞—Ç—å `any`)
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Zod –∏–ª–∏ Yup
- –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è HTML/—Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

---

## üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### 1.1 –£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π

```typescript
// –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
function addMessage(messages: Message[], newMessage: Message): Message[] {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ id (–≥–ª–∞–≤–Ω—ã–π –∫–ª—é—á)
  if (messages.some(m => m.id === newMessage.id)) {
    return messages; // –£–∂–µ –µ—Å—Ç—å
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ sequence_number –¥–ª—è –ø–æ—Ä—è–¥–∫–∞
  const existing = messages.find(m => 
    m.sequence_number === newMessage.sequence_number && 
    m.thread_id === newMessage.thread_id
  );
  
  if (existing) {
    // –ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
    return messages.map(m => 
      m.id === existing.id ? newMessage : m
    );
  }
  
  // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  return [...messages, newMessage].sort(compareMessages);
}
```

#### 1.2 –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

```sql
-- –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —Å –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
CREATE OR REPLACE FUNCTION dms_list_partners_optimized(
  p_user_id UUID,
  p_limit INTEGER,
  p_offset INTEGER
)
RETURNS TABLE (
  -- –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    -- –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  FROM dms_thread_participants tp
  JOIN profiles p ON p.user_id = tp.user_id
  LEFT JOIN dms_messages m ON m.thread_id = tp.thread_id
  WHERE tp.user_id = p_user_id
  GROUP BY ...
  ORDER BY ...
  LIMIT p_limit OFFSET p_offset;
END;
$$ LANGUAGE plpgsql;
```

#### 1.3 –£–ª—É—á—à–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é

```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sequence_number –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
async function syncMessages(
  threadId: ThreadId,
  lastSequenceNumber: number | null
): Promise<Message[]> {
  const query = supabase
    .from('dms_messages')
    .select('*')
    .eq('thread_id', threadId);
  
  if (lastSequenceNumber !== null) {
    query.gt('sequence_number', lastSequenceNumber);
  }
  
  const { data } = await query
    .order('sequence_number', { ascending: true })
    .limit(100);
  
  return data || [];
}
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –£–ª—É—á—à–µ–Ω–∏—è UX

#### 2.1 –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞

```typescript
// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
function MessageStatus({ message }: { message: Message }) {
  const status = getMessageStatus(message);
  
  return (
    <span className="message-status">
      {status === 'sending' && <Spinner />}
      {status === 'sent' && <CheckIcon />}
      {status === 'delivered' && <DoubleCheckIcon />}
      {status === 'read' && <DoubleCheckIcon className="read" />}
      {status === 'failed' && <ErrorIcon />}
    </span>
  );
}
```

#### 2.2 –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

```typescript
// –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
class DmErrorHandler {
  static handle(error: Error, context: string) {
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    console.error(`[DM Error] ${context}:`, error);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Sentry
    if (typeof window !== 'undefined' && (window as any).Sentry) {
      (window as any).Sentry.captureException(error, {
        tags: { context, component: 'dms' }
      });
    }
    
    // –ü–æ–∫–∞–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    showToast({
      message: this.getUserFriendlyMessage(error),
      type: 'error'
    });
  }
  
  static getUserFriendlyMessage(error: Error): string {
    if (error.message.includes('network')) {
      return '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.';
    }
    if (error.message.includes('rate_limited')) {
      return '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.';
    }
    return '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
  }
}
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

#### 3.1 Redis –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis Pub/Sub
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

// –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
async function publishMessage(threadId: ThreadId, message: Message) {
  await redis.publish(
    `dm:thread:${threadId}`,
    JSON.stringify(message)
  );
}

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function subscribeToThread(threadId: ThreadId, callback: (msg: Message) => void) {
  const subscriber = redis.duplicate();
  await subscriber.subscribe(`dm:thread:${threadId}`);
  
  subscriber.on('message', (channel, message) => {
    callback(JSON.parse(message));
  });
  
  return () => subscriber.unsubscribe();
}
```

#### 3.2 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IndexedDB –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤
import { openDB, DBSchema } from 'idb';

interface DmDB extends DBSchema {
  messages: {
    key: number;
    value: Message;
    indexes: { 'thread_id': number; 'created_at': Date };
  };
  partners: {
    key: string;
    value: PartnerListItem;
  };
}

const db = await openDB<DmDB>('dms-db', 1, {
  upgrade(db) {
    const messagesStore = db.createObjectStore('messages', { keyPath: 'id' });
    messagesStore.createIndex('thread_id', 'thread_id');
    messagesStore.createIndex('created_at', 'created_at');
    
    db.createObjectStore('partners', { keyPath: 'user_id' });
  }
});

// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
async function cacheMessages(threadId: ThreadId, messages: Message[]) {
  const tx = db.transaction('messages', 'readwrite');
  for (const msg of messages) {
    await tx.store.put(msg);
  }
  await tx.done;
}
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

#### 4.1 –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è

```typescript
// –£–±—Ä–∞—Ç—å –≤—Å–µ any, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–∏–µ —Ç–∏–ø—ã
type Message = {
  id: number;
  thread_id: ThreadId;
  sender_id: string;
  kind: 'text' | 'system';
  body: string | null;
  attachments: Attachment[];
  created_at: string;
  edited_at: string | null;
  deleted_at: string | null;
  sequence_number: number;
  client_msg_id: string | null;
};

type Attachment = {
  id: string;
  type: 'image' | 'video' | 'audio' | 'document';
  url: string;
  size: number;
  mime: string;
  originalName: string;
};
```

#### 4.2 –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```typescript
import { z } from 'zod';

const MessageSchema = z.object({
  id: z.number().int().positive(),
  thread_id: z.string(),
  sender_id: z.string().uuid(),
  kind: z.enum(['text', 'system']),
  body: z.string().nullable(),
  attachments: z.array(AttachmentSchema),
  created_at: z.string().datetime(),
  edited_at: z.string().datetime().nullable(),
  deleted_at: z.string().datetime().nullable(),
  sequence_number: z.number().int().positive(),
  client_msg_id: z.string().uuid().nullable(),
});

function validateMessage(data: unknown): Message {
  return MessageSchema.parse(data);
}
```

#### 4.3 –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```typescript
import DOMPurify from 'dompurify';

function sanitizeMessage(text: string): string {
  // –£–¥–∞–ª–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–π HTML
  return DOMPurify.sanitize(text, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'code', 'pre'],
    ALLOWED_ATTR: ['href', 'target', 'rel']
  });
}
```

---

## üìã –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
2. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
3. ‚úÖ –£–ª—É—á—à–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ sequence_number
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

### –§–∞–∑–∞ 2: –£–ª—É—á—à–µ–Ω–∏—è UX (1 –Ω–µ–¥–µ–ª—è)
1. ‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
2. ‚úÖ –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (IndexedDB)

### –§–∞–∑–∞ 3: –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
2. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å WebSocket gateway
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### –§–∞–∑–∞ 4: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ (1 –Ω–µ–¥–µ–ª—è)
1. ‚úÖ –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è (—É–±—Ä–∞—Ç—å any)
2. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (Zod)
3. ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (DOMPurify)

---

## üéØ –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚è±Ô∏è –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤: < 200ms
- ‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: < 100ms
- ‚è±Ô∏è –í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏: < 500ms

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ 0% –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ 99.9% —É—Å–ø–µ—à–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
- ‚úÖ 0% –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

### UX
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ü–ª–∞–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –ª–∞–≥–æ–≤

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è**: `zod` - —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º
2. **–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è**: `dompurify` - –æ—á–∏—Å—Ç–∫–∞ HTML
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: `idb` - IndexedDB wrapper
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: `@sentry/nextjs` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
5. **Redis**: `ioredis` - Redis –∫–ª–∏–µ–Ω—Ç –¥–ª—è Node.js

### –ò–Ω–¥–µ–∫—Å—ã –ë–î

```sql
-- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_dms_messages_thread_sequence 
ON dms_messages(thread_id, sequence_number);

CREATE INDEX idx_dms_thread_participants_user_thread 
ON dms_thread_participants(user_id, thread_id);

CREATE INDEX idx_dms_message_receipts_message_user 
ON dms_message_receipts(message_id, user_id);
```

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ DMs —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞, –Ω–æ –∏–º–µ–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å:
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é
- UX (—Å—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π)

–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ—à–∞—Ç —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Å–¥–µ–ª–∞—é—Ç —Å–∏—Å—Ç–µ–º—É –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π, –±—ã—Å—Ç—Ä–æ–π –∏ —É–¥–æ–±–Ω–æ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –û–±—Å—É–¥–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å –∫–æ–º–∞–Ω–¥–æ–π
2. –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ —Ç—Ä–µ–∫–µ—Ä–µ (Jira/GitHub Issues)
3. –ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
4. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –≤–Ω–µ–¥—Ä—è—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
