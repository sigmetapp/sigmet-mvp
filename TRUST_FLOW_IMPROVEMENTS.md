# Trust Flow Improvements - Кэширование и История Изменений

## Обзор

Реализована система кэширования Trust Flow (TF) и отслеживания истории всех изменений. Это обеспечивает:
1. **Быструю загрузку** TF на странице пользователя (из кэша)
2. **Автоматическое сохранение** актуального TF в базу данных
3. **Полную историю изменений** с метаданными

## Изменения в базе данных

### 1. Колонка `trust_flow` в таблице `profiles`
- Добавлена колонка `trust_flow numeric(10, 2) DEFAULT 5.0`
- Индексирована для быстрых запросов
- Хранит актуальное значение TF для каждого пользователя

### 2. Таблица `trust_flow_history`
- Отслеживает все изменения TF
- Поля:
  - `user_id` - пользователь, чей TF изменился
  - `old_value` / `new_value` - старое и новое значение
  - `change_reason` - причина изменения ('push_created', 'push_deleted', 'manual_recalc', 'backfill', etc.)
  - `push_id` - ID push, который вызвал изменение (если применимо)
  - `calculated_by` - кто/что рассчитал ('api', 'trigger', 'admin')
  - `metadata` - дополнительные данные (jsonb)
  - `created_at` - время изменения

### 3. Функция `update_user_trust_flow()`
- Обновляет кэш в `profiles.trust_flow`
- Логирует изменение в `trust_flow_history` (только если значение изменилось)
- Использует `SECURITY DEFINER` для безопасного выполнения

### 4. Функция `get_users_needing_tf_recalc()`
- Помогает найти пользователей, которым нужен пересчет TF
- Используется для backfill операций

## Изменения в коде

### `lib/trustFlow.ts`

#### Новые функции:

1. **`saveTrustFlowToCache()`** - сохраняет рассчитанный TF в кэш и логирует историю
2. **`getCachedTrustFlow()`** - получает TF из кэша
3. **`calculateAndSaveTrustFlow()`** - главная функция: рассчитывает и сохраняет TF
   - Опция `useCache: true` - использовать кэш если доступен
   - Автоматически сохраняет в кэш после расчета

#### Экспортированная константа:
- `BASE_TRUST_FLOW = 5.0` - базовое значение TF

### `pages/api/users/[id]/trust-flow.ts`

Обновлен API endpoint:
- **По умолчанию**: читает из кэша (быстро)
- **Если кэша нет**: рассчитывает и сохраняет
- **Параметр `?recalculate=true`**: принудительный пересчет
- Кэширование HTTP ответа: 1 минута

### `app/(auth)/u/[slug]/page.tsx`

Обновлена страница пользователя:
- Загружает TF из кэша при открытии страницы
- После создания push: пересчитывает TF с `recalculate=true`
- Упрощена логика retry (меньше попыток, т.к. теперь быстрее)

### `pages/api/admin/trust-flow/backfill.ts`

Новый admin endpoint для массового пересчета:
- Обрабатывает пользователей порциями
- Пересчитывает и кэширует TF
- Возвращает статистику изменений

## Как это работает

### Обычная загрузка страницы:
1. Фронтенд запрашивает `/api/users/{id}/trust-flow`
2. API проверяет кэш в `profiles.trust_flow`
3. Если есть кэш → возвращает сразу (быстро!)
4. Если нет кэша → рассчитывает, сохраняет в кэш, возвращает

### После создания Trust Push:
1. Push сохраняется в `trust_pushes`
2. Фронтенд вызывает API с `?recalculate=true`
3. API пересчитывает TF (учитывая новый push)
4. Сохраняет в кэш через `update_user_trust_flow()`
5. Функция автоматически логирует изменение в `trust_flow_history`

### История изменений:
- Каждое изменение TF записывается в `trust_flow_history`
- Можно отследить: когда, почему, кто/что изменило TF
- Связь с конкретным push через `push_id`

## Миграция

Файл: `supabase/migrations/225_add_trust_flow_caching_and_history.sql`

Выполнить миграцию:
```sql
-- Миграция создаст:
-- 1. Колонку trust_flow в profiles
-- 2. Таблицу trust_flow_history
-- 3. Функции для работы с кэшем
-- 4. Инициализирует trust_flow = 5.0 для всех существующих пользователей
```

## Backfill существующих данных

После миграции нужно пересчитать TF для всех пользователей:

```bash
# Через API (порциями по 100 пользователей)
POST /api/admin/trust-flow/backfill?limit=100&offset=0
POST /api/admin/trust-flow/backfill?limit=100&offset=100
# и т.д.
```

Или напрямую через SQL:
```sql
-- Получить список пользователей для пересчета
SELECT * FROM get_users_needing_tf_recalc();

-- Пересчитать вручную для конкретного пользователя
SELECT update_user_trust_flow(
  'user-id-here'::uuid,
  15.5, -- новое значение (рассчитанное в приложении)
  'backfill',
  NULL,
  'admin',
  '{"backfill": true}'::jsonb
);
```

## Преимущества

1. **Производительность**: 
   - Загрузка TF из кэша: ~1-5ms вместо 50-200ms расчета
   - Меньше нагрузки на БД

2. **Надежность**:
   - История всех изменений
   - Возможность отката/аудита
   - Отслеживание причин изменений

3. **Гибкость**:
   - Можно принудительно пересчитать через API
   - Backfill для массовых операций
   - Метаданные для дополнительной информации

## Примечания

- Расчет TF остается в TypeScript (не в SQL триггерах) для консистентности
- Кэш обновляется после каждого расчета
- История записывается только если значение изменилось
- Базовое значение TF = 5.0 для всех новых пользователей
